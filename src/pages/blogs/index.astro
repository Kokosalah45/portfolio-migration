---
import { getCollection } from "astro:content";
import Layout from "../../layouts/Layout.astro";
import MainContent from "../../layouts/MainContent.astro";
import Filter from "../../components/Filter.svelte";

const allBlogPosts = await getCollection("blog");
const searchParams = Astro.url.searchParams;

// Get current tag from URL
const currentTag = searchParams.get("tags") || "";

// Filter posts based on tag parameter
const filteredPosts = currentTag 
  ? allBlogPosts.filter(post => post.data.tags?.includes(currentTag))
  : allBlogPosts;

// Get all available tags for the filter component
const availableTags = [...new Set(allBlogPosts.flatMap(post => post.data.tags || []))].sort();

// SEO and meta information
const pageTitle = currentTag ? `Blog Posts - ${currentTag}` : "Blog Posts";
const pageDescription = currentTag 
  ? `Blog posts tagged with ${currentTag}`
  : "All blog posts";
---

<Layout title={pageTitle}>
  
  <slot slot='main'>
    <MainContent isFullSpan>
      <h1 class="text-4xl font-bold mb-6" style="color: var(--color-title);">
        {currentTag ? `${currentTag} Posts` : 'Blog Posts'}
      </h1>
      
      <!-- Filter component -->
      <Filter client:load currentTag={currentTag} availableTags={availableTags} />
      
      <!-- Results count -->
      <div class="mb-6" style="color: var(--color-secondary-text);">
        Showing {filteredPosts.length} of {allBlogPosts.length} posts
        {currentTag && ` tagged with "${currentTag}"`}
      </div>
      
      <!-- Blog posts list -->
      <ul class="space-y-4">
        {filteredPosts.map((post) => (
          <li class="border p-4 rounded-lg transition" style="background-color: var(--color-secondary); border-color: var(--color-separator);">
            <a href={`/blogs/${post.slug}`} class="text-xl font-semibold hover:underline transition-colors" style="color: var(--color-subtitle);">
              {post.data.title}
            </a>
            <p class="mt-2" style="color: var(--color-regular-text);">{post.data.excerpt}</p>
            <div class="flex justify-between items-center mt-3">
              <span class="text-sm" style="color: var(--color-secondary-text);">
                {new Date(post.data.date).toLocaleDateString()}
              </span>
              <div class="flex gap-2">
                {post.data.tags?.map((tag: string) => (
                  <span class="px-2 py-1 text-xs rounded-full" style="background-color: var(--color-separator); color: var(--color-secondary-text);">
                    {tag}
                  </span>
                ))}
              </div>
            </div>
          </li>
        ))}
      </ul>
      
      <!-- No results state -->
      {filteredPosts.length === 0 && (
        <div class="text-center py-12" style="color: var(--color-secondary-text);">
          <h2 class="text-2xl font-semibold mb-4">No posts found</h2>
          <p class="mb-6">No posts are tagged with "{currentTag}".</p>
          <a 
            href="/blogs" 
            class="inline-block px-6 py-3 rounded-md font-medium transition-colors"
            style="background-color: var(--color-text-active); color: var(--color-primary); text-decoration: none;"
          >
            View All Posts
          </a>
        </div>
      )}
    </MainContent>
  </slot>
</Layout>